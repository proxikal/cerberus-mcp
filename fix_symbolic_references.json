[
  {
    "op": "edit",
    "file": "src/cerberus/cli/symbolic.py",
    "symbol": "references_cmd",
    "code": "@app.command(\"references\")\ndef references_cmd(\n    source_symbol: Optional[str] = typer.Option(None, \"--source\", \"-s\", help=\"Filter by source symbol name.\"),\n    target_symbol: Optional[str] = typer.Option(None, \"--target\", \"-t\", help=\"Filter by target symbol name.\"),\n    reference_type: Optional[str] = typer.Option(\n        None,\n        \"--type\",\n        help=\"Filter by reference type (method_call, instance_of, inherits, type_annotation, return_type).\"\n    ),\n    min_confidence: Optional[float] = typer.Option(None, \"--min-confidence\", \"-c\", help=\"Minimum confidence score (0.0-1.0).\"),\n    source_file: Optional[Path] = typer.Option(None, \"--source-file\", help=\"Filter by source file path.\"),\n    target_file: Optional[Path] = typer.Option(None, \"--target-file\", help=\"Filter by target file path.\"),\n    index_path: Optional[Path] = typer.Option(\n        None,\n        \"--index\",\n        \"-i\",\n        help=\"Path to index file. Defaults to 'cerberus.db' in CWD.\",\n        dir_okay=False,\n        readable=True,\n    ),\n    limit: int = typer.Option(100, \"--limit\", \"-l\", help=\"Maximum number of results to return.\"),\n    json_output: bool = typer.Option(False, \"--json\", help=\"Output as JSON.\"),\n):\n    \"\"\"\n    [PHASE 5.3] Query symbol references resolved by type tracking.\n\n    Find references from symbol usages to their definitions. This enables AI agents\n    to navigate instanceâ†’definition relationships and understand type resolution.\n\n    Examples:\n      cerberus references --source optimizer --json\n      cerberus references --target Adam --type method_call --json\n      cerberus references --min-confidence 0.8 --json\n      cerberus references --source-file src/train.py --json\n    \"\"\"\n    from cerberus.storage.sqlite_store import SQLiteIndexStore\n\n    index_path = get_default_index(index_path)\n\n    try:\n        store = SQLiteIndexStore(str(index_path))\n\n        # Query with filters\n        source_file_str = str(source_file.absolute()) if source_file else None\n        target_file_str = str(target_file.absolute()) if target_file else None\n\n        results = list(store.query_symbol_references_filtered(\n            source_symbol=source_symbol,\n            target_symbol=target_symbol,\n            reference_type=reference_type,\n            min_confidence=min_confidence,\n            source_file=source_file_str,\n            target_file=target_file_str,\n        ))\n\n        # Limit results\n        results = results[:limit]\n\n        if CLIConfig.is_machine_mode() or json_output:\n            output = {\n                \"total\": len(results),\n                \"references\": [\n                    {\n                        \"source_file\": ref.source_file,\n                        \"source_line\": ref.source_line,\n                        \"source_symbol\": ref.source_symbol,\n                        \"reference_type\": ref.reference_type,\n                        \"target_file\": ref.target_file,\n                        \"target_symbol\": ref.target_symbol,\n                        \"target_type\": ref.target_type,\n                        \"confidence\": ref.confidence,\n                        \"resolution_method\": ref.resolution_method,\n                    }\n                    for ref in results\n                ]\n            }\n            typer.echo(json.dumps(output, indent=2))\n        else:\n            if not results:\n                console.print(\"[yellow]No symbol references found matching the filters.[/yellow]\")\n                return\n\n            table = Table(title=f\"Symbol References ({len(results)} found)\")\n            table.add_column(\"Source\", style=\"cyan\")\n            table.add_column(\"Type\", style=\"yellow\")\n            table.add_column(\"Target\", style=\"green\")\n            table.add_column(\"Confidence\", style=\"magenta\")\n            table.add_column(\"Method\", style=\"dim\")\n\n            for ref in results:\n                source_str = f\"{ref.source_file}:{ref.source_line} ({ref.source_symbol})\"\n                target_str = f\"{ref.target_symbol or 'unknown'}\"\n                if ref.target_type:\n                    target_str += f\" [{ref.target_type}]\"\n                confidence_str = f\"{ref.confidence:.2f}\"\n\n                table.add_row(\n                    source_str,\n                    ref.reference_type or \"unknown\",\n                    target_str,\n                    confidence_str,\n                    ref.resolution_method or \"N/A\"\n                )\n\n            console.print(table)\n\n    except Exception as e:\n        logger.error(f\"Failed to query references: {e}\")\n        if CLIConfig.is_machine_mode() or json_output:\n            error = {\"error\": str(e), \"code\": \"QUERY_FAILED\"}\n            typer.echo(json.dumps(error, indent=2))\n        else:\n            console.print(f\"[red]Error: {e}[/red]\")\n        raise typer.Exit(code=1)"
  }
]
